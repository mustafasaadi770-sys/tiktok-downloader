import telebot
import requests
import os
from threading import Thread
from flask import Flask
from moviepy.editor import VideoFileClip, TextClip, CompositeVideoClip

# ... (نفس الجزء الأول من كودك الخاص بـ Flask و get_data) ...

# --- 3. معالجة الفيديو المرسل كملف (وضع بصمة مرئية) ---
@bot.message_handler(content_types=['video'])
def handle_uploaded_video(message):
    try:
        wait_msg = bot.reply_to(message, "⏳ جاري وضع بصمتك المرئية على الفيديو...")
        
        # 1. تحميل الفيديو من تليجرام
        file_info = bot.get_file(message.video.file_id)
        downloaded_file = bot.download_file(file_info.file_path)
        input_path = "input_temp.mp4"
        output_path = "output_pro.mp4"
        
        with open(input_path, 'wb') as f:
            f.write(downloaded_file)

        # 2. معالجة الفيديو وإضافة النص
        video_clip = VideoFileClip(input_path)
        
        # إنشاء بصمتك كصورة نصية تظهر فوق الفيديو
        # ملاحظة: يمكنك تغيير fontsize (حجم الخط) حسب رغبتك
        txt_clip = TextClip(MY_RIGHTS, fontsize=40, color='white', font='Arial-Bold')
        txt_clip = txt_clip.set_position(('right', 'top')).set_duration(video_clip.duration).margin(right=20, top=20, opacity=0)

        # دمج البصمة مع الفيديو
        result = CompositeVideoClip([video_clip, txt_clip])
        result.write_videofile(output_path, codec="libx264", audio_codec="aac")

        # 3. إرسال الفيديو النهائي
        with open(output_path, 'rb') as v:
            bot.send_video(message.chat.id, v, caption=f"تمت المعالجة بنجاح ✅ {MY_RIGHTS}")

        # تنظيف الملفات لإخلاء مساحة السيرفر
        video_clip.close()
        result.close()
        os.remove(input_path)
        os.remove(output_path)
        bot.delete_message(message.chat.id, wait_msg.message_id)

    except Exception as e:
        bot.reply_to(message, f"❌ حدث خطأ أثناء المعالجة: {str(e)}")

# ... (بقية كود الأوامر والتحميل من الروابط كما هي في كودك) ...
