import telebot
import requests
import os
import yt_dlp
from threading import Thread
from flask import Flask

# --- 1. ØªØ´ØºÙŠÙ„ Ø³ÙŠØ±ÙØ± ÙˆÙ‡Ù…ÙŠ Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø¨ÙˆØª Ø­ÙŠØ§Ù‹ ---
app = Flask('')

@app.route('/')
def home():
    return "Bot is Live!"

def run():
    app.run(host='0.0.0.0', port=int(os.environ.get('PORT', 5000)))

def keep_alive():
    t = Thread(target=run)
    t.start()

# --- 2. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª ---
TOKEN = '8292214871:AAHSXs7jK95MQQVtQ1Sc4TCSNbMDuuE8h-w'
ADMIN_ID = 8286321204 
MY_RIGHTS = "@1.3vv"

bot = telebot.TeleBot(TOKEN)
users = set()

# Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª ØªÙŠÙƒ ØªÙˆÙƒ
def get_tiktok_data(url):
    try:
        api_url = f"https://www.tikwm.com/api/?url={url}"
        res = requests.get(api_url, timeout=15).json()
        if res.get('code') == 0:
            return res['data']
        return None
    except:
        return None

# Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª ÙŠÙˆØªÙŠÙˆØ¨
def get_youtube_data(url, mode):
    # mode 'v' Ù„Ù„Ù€ ÙÙŠØ¯ÙŠÙˆ Ùˆ 'a' Ù„Ù„Ù€ ØµÙˆØª
    try:
        ydl_opts = {
            'format': 'bestvideo+bestaudio/best' if mode == 'v' else 'bestaudio/best',
            'quiet': True,
            'no_warnings': True,
        }
        with yt_dlp.YoutubeDL(ydl_opts) as ydl:
            info = ydl.extract_info(url, download=False)
            return info['url']
    except:
        return None

# --- 3. Ø§Ù„Ø£ÙˆØ§Ù…Ø± ---
@bot.message_handler(commands=['start'])
def start(message):
    users.add(message.chat.id)
    bot.reply_to(message, f"Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ {message.from_user.first_name} ğŸ‘‹\nØ£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· ØªÙŠÙƒ ØªÙˆÙƒ Ø£Ùˆ ÙŠÙˆØªÙŠÙˆØ¨ ÙˆØ³Ø£Ø­Ù…Ù„Ù‡ Ù„Ùƒ!")

@bot.message_handler(commands=['admin'])
def admin(message):
    if message.from_user.id == ADMIN_ID:
        markup = telebot.types.InlineKeyboardMarkup()
        btn = telebot.types.InlineKeyboardButton("ğŸ“£ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø°Ø§Ø¹Ø©", callback_data="bc")
        markup.add(btn)
        bot.reply_to(message, f"ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: {len(users)}", reply_markup=markup)

# --- 4. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· (ØªÙŠÙƒ ØªÙˆÙƒ ÙˆÙŠÙˆØªÙŠÙˆØ¨) ---
@bot.message_handler(func=lambda m: True)
def handle_links(message):
    url = message.text.strip()
    
    if "tiktok.com" in url:
        wait_msg = bot.reply_to(message, "â³ Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© ØªÙŠÙƒ ØªÙˆÙƒ...")
        data = get_tiktok_data(url)
        if data:
            markup = telebot.types.InlineKeyboardMarkup()
            markup.add(
                telebot.types.InlineKeyboardButton("ğŸ¬ ÙÙŠØ¯ÙŠÙˆ", callback_data=f"tv_{url}"),
                telebot.types.InlineKeyboardButton("ğŸµ ØµÙˆØª", callback_data=f"ta_{url}")
            )
            bot.edit_message_text("âœ… ØªÙŠÙƒ ØªÙˆÙƒ - Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹:", message.chat.id, wait_msg.message_id, reply_markup=markup)
        else:
            bot.edit_message_text("âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª ØªÙŠÙƒ ØªÙˆÙƒ.", message.chat.id, wait_msg.message_id)

    elif "youtube.com" in url or "youtu.be" in url:
        wait_msg = bot.reply_to(message, "â³ Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© ÙŠÙˆØªÙŠÙˆØ¨...")
        markup = telebot.types.InlineKeyboardMarkup()
        markup.add(
            telebot.types.InlineKeyboardButton("ğŸ¬ ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØªÙŠÙˆØ¨", callback_data=f"yv_{url}"),
            telebot.types.InlineKeyboardButton("ğŸµ ØµÙˆØª ÙŠÙˆØªÙŠÙˆØ¨", callback_data=f"ya_{url}")
        )
        bot.edit_message_text("âœ… ÙŠÙˆØªÙŠÙˆØ¨ - Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹:", message.chat.id, wait_msg.message_id, reply_markup=markup)

# --- 5. Ø§Ù„ØªÙ†ÙÙŠØ° (Callback) ---
@bot.callback_query_handler(func=lambda call: True)
def callback(call):
    chat_id = call.message.chat.id
    url = call.data[3:] # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† Ø§Ù„Ù€ callback
    
    # Ù…Ø¹Ø§Ù„Ø¬Ø© ØªÙŠÙƒ ØªÙˆÙƒ
    if call.data.startswith("tv_"):
        data = get_tiktok_data(url)
        if data: bot.send_video(chat_id, data['play'], caption=MY_RIGHTS)
    elif call.data.startswith("ta_"):
        data = get_tiktok_data(url)
        if data: bot.send_audio(chat_id, data['music'], caption=MY_RIGHTS)
        
    # Ù…Ø¹Ø§Ù„Ø¬Ø© ÙŠÙˆØªÙŠÙˆØ¨
    elif call.data.startswith("yv_"):
        video_url = get_youtube_data(url, 'v')
        if video_url: bot.send_video(chat_id, video_url, caption=MY_RIGHTS)
        else: bot.send_message(chat_id, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØªÙŠÙˆØ¨")
        
    elif call.data.startswith("ya_"):
        audio_url = get_youtube_data(url, 'a')
        if audio_url: bot.send_audio(chat_id, audio_url, caption=MY_RIGHTS)
        else: bot.send_message(chat_id, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ØµÙˆØª ÙŠÙˆØªÙŠÙˆØ¨")

# --- 6. Ø§Ù„ØªØ´ØºÙŠÙ„ ---
if __name__ == "__main__":
    keep_alive()
    print("ğŸš€ Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ù…Ø·ÙˆØ± ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† (ÙŠÙˆØªÙŠÙˆØ¨ + ØªÙŠÙƒ ØªÙˆÙƒ)")
    bot.infinity_polling(skip_pending=True)
