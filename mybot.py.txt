import telebot
import requests
import os
import yt_dlp
from threading import Thread
from flask import Flask

# --- 1. Ø³ÙŠØ±ÙØ± Render ---
app = Flask('')
@app.route('/')
def home(): return "Bot is Live!"

def run():
    app.run(host='0.0.0.0', port=int(os.environ.get('PORT', 5000)))

def keep_alive():
    Thread(target=run).start()

# --- 2. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
TOKEN = '8292214871:AAHSXs7jK95MQQVtQ1Sc4TCSNbMDuuE8h-w'
MY_RIGHTS = "@1.3vv"
bot = telebot.TeleBot(TOKEN)

# Ø¯Ø§Ù„Ø© Ø°ÙƒÙŠØ© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ø£ÙŠ Ù…ÙˆÙ‚Ø¹ (Ø¨ÙŠÙ†ØªØ±Ø³ØªØŒ ØªÙŠÙƒ ØªÙˆÙƒØŒ Ø¥Ù„Ø®)
def download_video(url):
    ydl_opts = {
        'format': 'best',
        'quiet': True,
        'no_warnings': True,
    }
    try:
        with yt_dlp.YoutubeDL(ydl_opts) as ydl:
            info = ydl.extract_info(url, download=False)
            return info.get('url')
    except Exception as e:
        print(f"Error: {e}")
        return None

# Ø¯Ø§Ù„Ø© Ø®Ø§ØµØ© Ø¨ØªÙŠÙƒ ØªÙˆÙƒ (Ù„Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø¹Ù„Ù‰ Ø®ÙŠØ§Ø± Ø§Ù„ØµÙˆØª/Ø§Ù„ÙÙŠØ¯ÙŠÙˆ)
def get_tiktok_data(url):
    try:
        res = requests.get(f"https://www.tikwm.com/api/?url={url}").json()
        return res.get('data') if res.get('code') == 0 else None
    except: return None

# --- 3. Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ---

@bot.message_handler(func=lambda m: any(x in m.text for x in ["tiktok.com", "pinterest.com", "pin.it"]))
def handle_links(message):
    url = message.text.strip()
    wait_msg = bot.reply_to(message, "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„...")

    # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨ÙŠÙ†ØªØ±Ø³Øª
    if "pinterest" in url or "pin.it" in url:
        video_url = download_video(url)
        if video_url:
            bot.delete_message(message.chat.id, wait_msg.message_id)
            bot.send_video(message.chat.id, video_url, caption=f"ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø¨ÙŠÙ†ØªØ±Ø³Øª âœ…\n{MY_RIGHTS}")
        else:
            bot.edit_message_text("âŒ Ù„Ù… Ø£Ø¬Ø¯ ÙÙŠØ¯ÙŠÙˆ! ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù…Ù†Ø´ÙˆØ± ÙÙŠØ¯ÙŠÙˆ ÙˆÙ„ÙŠØ³ ØµÙˆØ±Ø©.", message.chat.id, wait_msg.message_id)

    # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ØªÙŠÙƒ ØªÙˆÙƒ (Ù†ÙØ³ Ù†Ø¸Ø§Ù…Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚)
    elif "tiktok.com" in url:
        data = get_tiktok_data(url)
        if data:
            markup = telebot.types.InlineKeyboardMarkup()
            markup.add(
                telebot.types.InlineKeyboardButton("ğŸ¬ ÙÙŠØ¯ÙŠÙˆ", callback_data=f"v_{url}"),
                telebot.types.InlineKeyboardButton("ğŸµ ØµÙˆØª", callback_data=f"a_{url}")
            )
            bot.edit_message_text("âœ… Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹:", message.chat.id, wait_msg.message_id, reply_markup=markup)
        else:
            bot.edit_message_text("âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª ØªÙŠÙƒ ØªÙˆÙƒ.", message.chat.id, wait_msg.message_id)

@bot.callback_query_handler(func=lambda call: True)
def callback(call):
    data = get_tiktok_data(call.data[2:])
    if not data: return
    if call.data.startswith("v_"):
        bot.send_video(call.message.chat.id, data['play'], caption=MY_RIGHTS)
    elif call.data.startswith("a_"):
        bot.send_audio(call.message.chat.id, data['music'], caption=MY_RIGHTS)

if __name__ == "__main__":
    keep_alive()
    bot.infinity_polling(skip_pending=True)
