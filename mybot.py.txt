import telebot
import requests
import os
from threading import Thread
from flask import Flask

# --- 1. Ø³ÙŠØ±ÙØ± Ø§Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø­ÙŠØ§Ù‹ ---
app = Flask('')
@app.route('/')
def home(): return "Bot is Live!"

def run(): app.run(host='0.0.0.0', port=int(os.environ.get('PORT', 5000)))
def keep_alive(): Thread(target=run).start()

# --- 2. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
TOKEN = '8292214871:AAHSXs7jK95MQQVtQ1Sc4TCSNbMDuuE8h-w'
ADMIN_ID = 8286321204 
MY_RIGHTS = "@1.3vv"

bot = telebot.TeleBot(TOKEN)
users = set()

# Ø¯Ø§Ù„Ø© ØªÙŠÙƒ ØªÙˆÙƒ (Ø¨Ù‚ÙŠØª ÙƒÙ…Ø§ Ù‡ÙŠ)
def get_tiktok_data(url):
    try:
        res = requests.get(f"https://www.tikwm.com/api/?url={url}", timeout=15).json()
        return res['data'] if res.get('code') == 0 else None
    except: return None

# Ø¯Ø§Ù„Ø© ÙŠÙˆØªÙŠÙˆØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (ØªØ³ØªØ®Ø¯Ù… API Ø®Ø§Ø±Ø¬ÙŠ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ø¸Ø±)
def get_youtube_api(url):
    try:
        # Ù†Ø³ØªØ®Ø¯Ù… API Ù…Ø¬Ø§Ù†ÙŠ ÙˆØ³Ø±ÙŠØ¹ Ù„Ø¬Ù„Ø¨ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„
        api_url = f"https://api.vyt.workers.dev/api/info?url={url}"
        res = requests.get(api_url, timeout=20).json()
        return res # ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù†
    except: return None

# --- 3. Ø§Ù„Ø£ÙˆØ§Ù…Ø± ---
@bot.message_handler(commands=['start'])
def start(message):
    users.add(message.chat.id)
    bot.reply_to(message, "Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· ØªÙŠÙƒ ØªÙˆÙƒ Ø£Ùˆ ÙŠÙˆØªÙŠÙˆØ¨ ÙˆØ³Ø£Ø­Ù…Ù„Ù‡ Ù„Ùƒ ÙÙˆØ±Ø§Ù‹ ğŸš€")

# --- 4. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ---
@bot.message_handler(func=lambda m: True)
def handle_links(message):
    url = message.text.strip()
    
    if "tiktok.com" in url:
        wait = bot.reply_to(message, "â³ Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© ØªÙŠÙƒ ØªÙˆÙƒ...")
        data = get_tiktok_data(url)
        if data:
            markup = telebot.types.InlineKeyboardMarkup()
            markup.add(telebot.types.InlineKeyboardButton("ğŸ¬ ÙÙŠØ¯ÙŠÙˆ", callback_data=f"tv_{url}"),
                       telebot.types.InlineKeyboardButton("ğŸµ ØµÙˆØª", callback_data=f"ta_{url}"))
            bot.edit_message_text("âœ… ØªÙŠÙƒ ØªÙˆÙƒ Ø¬Ø§Ù‡Ø²:", message.chat.id, wait.message_id, reply_markup=markup)
        else: bot.edit_message_text("âŒ ÙØ´Ù„ ØªÙŠÙƒ ØªÙˆÙƒ.", message.chat.id, wait.message_id)

    elif "youtube.com" in url or "youtu.be" in url:
        wait = bot.reply_to(message, "â³ Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© ÙŠÙˆØªÙŠÙˆØ¨ (Ø¨Ø¯ÙˆÙ† Ø­Ø¸Ø±)...")
        data = get_youtube_api(url)
        if data and 'formats' in data:
            markup = telebot.types.InlineKeyboardMarkup()
            # Ø³Ù†Ø¬Ù„Ø¨ Ø£ÙˆÙ„ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ ÙˆØ£ÙˆÙ„ Ø±Ø§Ø¨Ø· ØµÙˆØª Ù…ØªØ§Ø­ÙŠÙ†
            markup.add(telebot.types.InlineKeyboardButton("ğŸ¬ ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØªÙŠÙˆØ¨", callback_data=f"yv_{url}"),
                       telebot.types.InlineKeyboardButton("ğŸµ ØµÙˆØª ÙŠÙˆØªÙŠÙˆØ¨", callback_data=f"ya_{url}"))
            bot.edit_message_text(f"âœ… ÙŠÙˆØªÙŠÙˆØ¨: {data.get('title', 'ÙÙŠØ¯ÙŠÙˆ')}\nØ§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹:", message.chat.id, wait.message_id, reply_markup=markup)
        else: bot.edit_message_text("âŒ ÙŠÙˆØªÙŠÙˆØ¨ Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ØŒ Ø¬Ø±Ø¨ Ø±Ø§Ø¨Ø·Ø§Ù‹ Ø¢Ø®Ø±.", message.chat.id, wait.message_id)

# --- 5. Ø§Ù„ØªÙ†ÙÙŠØ° ---
@bot.callback_query_handler(func=lambda call: True)
def callback(call):
    url = call.data[3:]
    if call.data.startswith("tv_"):
        d = get_tiktok_data(url)
        if d: bot.send_video(call.message.chat.id, d['play'], caption=MY_RIGHTS)
    elif call.data.startswith("yv_"):
        d = get_youtube_api(url)
        if d: bot.send_video(call.message.chat.id, d['formats'][0]['url'], caption=MY_RIGHTS)

# --- 6. Ø§Ù„ØªØ´ØºÙŠÙ„ ---
if __name__ == "__main__":
    keep_alive()
    bot.infinity_polling(skip_pending=True)
