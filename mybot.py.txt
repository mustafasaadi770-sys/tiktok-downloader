import telebot
import requests
from telebot import types

# --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
TOKEN = '8292214871:AAFZe8_WHymePM6ii5NwH4u19vZGAEUB-dU'
ADMIN_ID = 8286321204
MY_RIGHTS = "@1.3vv"
bot = telebot.TeleBot(TOKEN)

users = set()

# Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª ØªÙŠÙƒ ØªÙˆÙƒ
def get_tiktok(url):
    try:
        res = requests.get(f"https://www.tikwm.com/api/?url={url}").json()
        if res['code'] == 0:
            return res['data']['play'], res['data']['music'], res['data'].get('title', 'TikTok')
    except: return None, None, None

# Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù†Ø³ØªØºØ±Ø§Ù… (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ù…Ø¬Ø§Ù†ÙŠ)
def get_insta(url):
    try:
        # Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ù†Ø³ØªØºØ±Ø§Ù… ÙŠØ­ØªØ§Ø¬ Ø£Ø­ÙŠØ§Ù†Ø§Ù‹ Ù„Ø®Ø¯Ù…Ø© Ø®Ø§Ø±Ø¬ÙŠØ© Ù„Ø£Ù† Ø­Ù…Ø§ÙŠØªÙ‡ Ù‚ÙˆÙŠØ©
        api_url = f"https://api.vkrhost.in/instagram/?url={url}"
        res = requests.get(api_url).json()
        if res.get('status'):
            return res['data']['url']
    except: return None

@bot.message_handler(commands=['start'])
def start(message):
    user_id = message.from_user.id
    user_name = message.from_user.first_name
    username = f"@{message.from_user.username}" if message.from_user.username else "Ø¨Ø¯ÙˆÙ† Ù…Ø¹Ø±Ù"
    
    if user_id not in users:
        users.add(user_id)
        # Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø·ÙˆØ± Ø¨Ø¯Ø®ÙˆÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
        bot.send_message(ADMIN_ID, f"ğŸ”” **Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ø¯Ø®Ù„ Ù„Ù„Ø¨ÙˆØª:**\nğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {user_name}\nğŸ†” Ø§Ù„Ø¢ÙŠØ¯ÙŠ: {user_id}\nğŸ”— Ø§Ù„ÙŠÙˆØ²Ø±: {username}")

    welcome_text = f"Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ {user_name} ÙÙŠ Ø¨ÙˆØª Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„ ğŸ“¥\n\n- Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· (ØªÙŠÙƒ ØªÙˆÙƒ) Ø£Ùˆ (Ø¥Ù†Ø³ØªØºØ±Ø§Ù…) Ù„Ù„ØªØ­Ù…ÙŠÙ„ ÙÙˆØ±Ø§Ù‹."
    bot.reply_to(message, welcome_text)

@bot.message_handler(commands=['stats'])
def stats(message):
    if message.from_user.id == ADMIN_ID:
        bot.reply_to(message, f"ğŸ“Š **Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙˆØª:**\n\nğŸ‘¤ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†: {len(users)}")

@bot.message_handler(func=lambda m: True)
def handle_links(message):
    url = message.text
    if 'tiktok.com' in url:
        msg = bot.reply_to(message, "â³ Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø§Ø¨Ø· ØªÙŠÙƒ ØªÙˆÙƒ...")
        video, audio, title = get_tiktok(url)
        if video:
            markup = types.InlineKeyboardMarkup()
            markup.add(types.InlineKeyboardButton("ğŸ¬ ØªØ­Ù…ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ", callback_data=f"vid_{url}"))
            markup.add(types.InlineKeyboardButton("ğŸµ ØªØ­Ù…ÙŠÙ„ ØµÙˆØª (MP3)", callback_data=f"aud_{url}"))
            bot.edit_message_text("Ø§Ø®ØªØ± Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„:", message.chat.id, msg.message_id, reply_markup=markup)
        else:
            bot.edit_message_text("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.", message.chat.id, msg.message_id)
            
    elif 'instagram.com' in url:
        msg = bot.reply_to(message, "â³ Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø§Ø¨Ø· Ø¥Ù†Ø³ØªØºØ±Ø§Ù…...")
        video_url = get_insta(url)
        if video_url:
            bot.send_video(message.chat.id, video_url, caption=f"âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¥Ù†Ø³ØªØºØ±Ø§Ù…\nØ­Ù‚ÙˆÙ‚: {MY_RIGHTS}")
            bot.delete_message(message.chat.id, msg.message_id)
        else:
            bot.edit_message_text("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ Ø¥Ù†Ø³ØªØºØ±Ø§Ù… (Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø­Ø³Ø§Ø¨ Ø®Ø§Øµ).", message.chat.id, msg.message_id)

@bot.callback_query_handler(func=lambda call: True)
def callback_query(call):
    type, url = call.data.split('_', 1)
    video, audio, title = get_tiktok(url)
    if type == "vid":
        bot.send_video(call.message.chat.id, video, caption=f"ğŸ¬: {title}\nØ­Ù‚ÙˆÙ‚: {MY_RIGHTS}")
    elif type == "aud":
        bot.send_audio(call.message.chat.id, audio, caption=f"ğŸµ: {title}\nØ­Ù‚ÙˆÙ‚: {MY_RIGHTS}")

bot.infinity_polling()
