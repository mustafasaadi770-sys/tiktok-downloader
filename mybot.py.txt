from moviepy.editor import VideoFileClip, TextClip, CompositeVideoClip

# --- 3. معالجة الفيديو: قص وإخفاء العلامة المائية ---
@bot.message_handler(content_types=['video'])
def handle_uploaded_video(message):
    try:
        wait_msg = bot.reply_to(message, "⏳ جاري معالجة الفيديو وإزالة العلامات المائية...")
        
        # تحميل الفيديو من تليجرام
        file_info = bot.get_file(message.video.file_id)
        downloaded_file = bot.download_file(file_info.file_path)
        input_path = "input_temp.mp4"
        output_path = "output_clean.mp4"
        
        with open(input_path, 'wb') as f:
            f.write(downloaded_file)

        # تحميل الفيديو للمعالجة
        clip = VideoFileClip(input_path)
        w, h = clip.size

        # 1. عملية القص (Crop): إزالة 10% من أعلى وأسفل الفيديو (أماكن الشعارات الشائعة)
        # يمكنك تعديل القيم (y1, y2) حسب الحاجة
        clipped_video = clip.crop(y1=60, y2=h-60) 

        # 2. إضافة بصمتك @1.3vv لإخفاء أي بقايا أو لتوثيق الفيديو
        txt_clip = TextClip(MY_RIGHTS, fontsize=35, color='white', font='Arial-Bold')
        # وضع الحقوق في الزاوية اليمنى العليا
        txt_clip = txt_clip.set_position(('right', 'top')).set_duration(clip.duration).margin(right=15, top=15, opacity=0)

        # دمج الفيديو المقصوص مع الحقوق
        final_video = CompositeVideoClip([clipped_video, txt_clip])
        final_video.write_videofile(output_path, codec="libx264", audio_codec="aac", threads=4)

        # إرسال النتيجة
        with open(output_path, 'rb') as v:
            bot.send_video(message.chat.id, v, caption=f"✅ تمت الإزالة والإضافة بواسطة: {MY_RIGHTS}")

        # تنظيف الذاكرة والملفات
        clip.close()
        final_video.close()
        os.remove(input_path)
        os.remove(output_path)
        bot.delete_message(message.chat.id, wait_msg.message_id)

    except Exception as e:
        bot.reply_to(message, f"❌ حدث خطأ: {str(e)}\nتأكد من تثبيت moviepy")
