import telebot
import requests
import os
from threading import Thread
from flask import Flask

# --- 1. ØªØ´ØºÙŠÙ„ Ø³ÙŠØ±ÙØ± ÙˆÙ‡Ù…ÙŠ Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø¨ÙˆØª Ø­ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Render ---
app = Flask('')

@app.route('/')
def home():
    return "Bot is Live!"

def run():
    app.run(host='0.0.0.0', port=int(os.environ.get('PORT', 5000)))

def keep_alive():
    t = Thread(target=run)
    t.start()

# --- 2. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª ---
# Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„ØµØ­ÙŠØ­ ÙˆØ§Ù„Ù…Ø­Ø¯Ø« Ù…Ù† ØµÙˆØ±Ùƒ
TOKEN = '8292214871:AAHJwB6DqRxZ240SDD-Ke3YzIKQbX4YA3TE'
ADMIN_ID = 8286321204 
MY_RIGHTS = "@1.3vv"

bot = telebot.TeleBot(TOKEN)

# ØªØ®Ø²ÙŠÙ† Ù…Ø¤Ù‚Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ù„Ù„Ø¥Ø°Ø§Ø¹Ø©)
users = set()

# Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† API
def get_data(url):
    try:
        api_url = f"https://www.tikwm.com/api/?url={url}"
        res = requests.get(api_url, timeout=15).json()
        if res.get('code') == 0:
            return res['data']
        return None
    except:
        return None

# --- 3. Ø§Ù„Ø£ÙˆØ§Ù…Ø± ---

# Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ ÙˆØ­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
@bot.message_handler(commands=['start'])
def start(message):
    users.add(message.chat.id)
    bot.reply_to(message, f"Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ {message.from_user.first_name} ğŸ‘‹\nØ£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· ØªÙŠÙƒ ØªÙˆÙƒ ÙˆØ³Ø£Ø­Ù…Ù„Ù‡ Ù„Ùƒ ÙÙˆØ±Ø§Ù‹!")

# Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù„Ø£Ø¯Ù…Ù†
@bot.message_handler(commands=['admin'])
def admin(message):
    if message.from_user.id == ADMIN_ID:
        markup = telebot.types.InlineKeyboardMarkup()
        btn = telebot.types.InlineKeyboardButton("ğŸ“£ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø°Ø§Ø¹Ø©", callback_data="bc")
        markup.add(btn)
        bot.reply_to(message, f"ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹: {len(users)}", reply_markup=markup)

# --- 4. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„ ---
@bot.message_handler(func=lambda m: "tiktok.com" in m.text or "instagram.com" in m.text)
def handle_download(message):
    users.add(message.chat.id)
    url = message.text.strip()
    wait_msg = bot.reply_to(message, "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...")
    
    data = get_data(url)
    if data:
        markup = telebot.types.InlineKeyboardMarkup()
        markup.add(
            telebot.types.InlineKeyboardButton("ğŸ¬ ÙÙŠØ¯ÙŠÙˆ", callback_data=f"v_{url}"),
            telebot.types.InlineKeyboardButton("ğŸµ ØµÙˆØª", callback_data=f"a_{url}")
        )
        bot.edit_message_text("âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù‚Ø·Ø¹ØŒ Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹:", message.chat.id, wait_msg.message_id, reply_markup=markup)
    else:
        bot.edit_message_text("âŒ ÙØ´Ù„ Ø§Ù„Ø¬Ù„Ø¨ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·.", message.chat.id, wait_msg.message_id)

# --- 5. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± (ØªØ­Ù…ÙŠÙ„ ÙˆØ¥Ø°Ø§Ø¹Ø©) ---
@bot.callback_query_handler(func=lambda call: True)
def callback(call):
    if call.data.startswith("v_"):
        data = get_data(call.data[2:])
        if data: bot.send_video(call.message.chat.id, data['play'], caption=MY_RIGHTS)
    
    elif call.data.startswith("a_"):
        data = get_data(call.data[2:])
        if data: bot.send_audio(call.message.chat.id, data['music'], caption=MY_RIGHTS)
    
    elif call.data == "bc":
        msg = bot.send_message(call.message.chat.id, "Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø¥Ø°Ø§Ø¹ØªÙ‡Ø§ Ù„Ù„ÙƒÙ„:")
        bot.register_next_step_handler(msg, send_bc)

def send_bc(message):
    count = 0
    for user in users:
        try:
            bot.copy_message(user, message.chat.id, message.message_id)
            count += 1
        except: continue
    bot.send_message(message.chat.id, f"âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø°Ø§Ø¹Ø© Ù„Ù€ {count} Ù…Ø³ØªØ®Ø¯Ù….")

# --- 6. Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ---
if __name__ == "__main__":
    keep_alive() # ØªØ´ØºÙŠÙ„ Flask Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Render Ø³Ø¹ÙŠØ¯Ø§Ù‹
    print("ğŸš€ Ø§Ù„Ø¨ÙˆØª Ø§Ù†Ø·Ù„Ù‚ Ø¨Ù†Ø¬Ø§Ø­...")
    bot.infinity_polling(skip_pending=True)
