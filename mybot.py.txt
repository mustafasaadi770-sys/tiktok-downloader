import telebot
import requests
import time

# --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ---
# Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠÙØ¶Ù„ ØªØºÙŠÙŠØ± Ø§Ù„ØªÙˆÙƒÙ† Ù…Ù† BotFather ÙƒÙ…Ø§ Ù†ØµØ­ØªÙƒ Ø³Ø§Ø¨Ù‚Ø§Ù‹ Ù„Ù„Ø£Ù…Ø§Ù†
TOKEN = '8292214871:AAFZe8_WHymePM6ii5NwH4u19vZGAEUB-dU'
ADMIN_ID = 8286321204 
MY_RIGHTS = "@1.3vv"
bot = telebot.TeleBot(TOKEN)

# ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
users = set()
download_count = 0

def get_data(url):
    try:
        # Ø¥Ø¶Ø§ÙØ© ØªØ±ÙˆÙŠØ³Ø§Øª Ù„ØªÙ‚Ù„ÙŠØ¯ Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ ÙˆØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ø¸Ø±
        headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36'
        }
        api_url = f"https://www.tikwm.com/api/?url={url}"
        res = requests.get(api_url, headers=headers, timeout=15).json()
        
        if res.get('code') == 0:
            return res['data']
        return None
    except Exception as e:
        print(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø­Ø±Ø±: {e}")
        return None

# --- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·) ---
@bot.message_handler(commands=['admin'])
def admin_panel(message):
    if message.from_user.id == ADMIN_ID:
        msg = f"ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙˆØª:\n\nğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: {len(users)}\nğŸ“¥ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª: {download_count}"
        markup = telebot.types.InlineKeyboardMarkup()
        btn = telebot.types.InlineKeyboardButton("ğŸ“£ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø°Ø§Ø¹Ø© Ù„Ù„ÙƒÙ„", callback_data="broadcast")
        markup.add(btn)
        bot.reply_to(message, msg, reply_markup=markup)
    else:
        bot.reply_to(message, "âŒ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù…Ø®ØµØµ Ù„Ù…Ø·ÙˆØ± Ø§Ù„Ø¨ÙˆØª ÙÙ‚Ø·.")

# --- Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ ---
@bot.message_handler(commands=['start'])
def start(message):
    users.add(message.from_user.id)
    first_name = message.from_user.first_name
    welcome = f"Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ {first_name} ğŸ‘‹\nØ£Ù†Ø§ Ø¨ÙˆØª Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† ØªÙŠÙƒ ØªÙˆÙƒ.\n\nØ£Ø±Ø³Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¢Ù† ÙˆØ³Ø£Ù‚ÙˆÙ… Ø¨Ø¬Ù„Ø¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ùƒ!"
    bot.reply_to(message, welcome)

# --- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ---
@bot.message_handler(func=lambda m: ("tiktok.com" in m.text or "instagram.com" in m.text))
def handle_all(message):
    url = message.text.strip()
    users.add(message.from_user.id)
    msg = bot.reply_to(message, "â³ Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...")
    
    data = get_data(url)
    if data:
        global download_count
        download_count += 1
        
        markup = telebot.types.InlineKeyboardMarkup()
        btn1 = telebot.types.InlineKeyboardButton("ğŸ¬ ØªØ­Ù…ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ", callback_data=f"vid_{url}")
        btn2 = telebot.types.InlineKeyboardButton("ğŸµ ØªØ­Ù…ÙŠÙ„ ØµÙˆØª MP3", callback_data=f"aud_{url}")
        markup.add(btn1, btn2)
        
        bot.edit_message_text("âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ! Ø§Ø®ØªØ± Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯:", message.chat.id, msg.message_id, reply_markup=markup)
    else:
        bot.edit_message_text("âŒ Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ø­Ø§Ù„ÙŠØ§Ù‹. Ø­Ø§ÙˆÙ„ Ù…Ø¹ Ø±Ø§Ø¨Ø· Ø¢Ø®Ø± Ø£Ùˆ Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹.", message.chat.id, msg.message_id)

# --- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± ---
@bot.callback_query_handler(func=lambda call: True)
def callback_query(call):
    try:
        bot.answer_callback_query(call.id, "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...")
        url = call.data[4:]
        
        if call.data.startswith("vid_"):
            data = get_data(url)
            if data:
                bot.send_video(call.message.chat.id, data['play'], caption=f"ğŸ‘¤ Ø¨ÙˆØ§Ø³Ø·Ø©: {MY_RIGHTS}")
            
        elif call.data.startswith("aud_"):
            data = get_data(url)
            if data:
                bot.send_audio(call.message.chat.id, data['music'], caption=f"ğŸµ Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ\nğŸ‘¤ Ø¨ÙˆØ§Ø³Ø·Ø©: {MY_RIGHTS}")

        elif call.data == "broadcast":
            if call.from_user.id == ADMIN_ID:
                msg = bot.send_message(call.message.chat.id, "Ø£Ø±Ø³Ù„ Ø§Ù„Ø¢Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø¥Ø°Ø§Ø¹ØªÙ‡Ø§:")
                bot.register_next_step_handler(msg, send_broadcast)
                
    except Exception as e:
        print(f"Error in buttons: {e}")

def send_broadcast(message):
    count = 0
    for user in users:
        try:
            bot.send_message(user, message.text)
            count += 1
        except: continue
    bot.send_message(message.chat.id, f"âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø°Ø§Ø¹Ø© Ù„Ù€ {count} Ù…Ø³ØªØ®Ø¯Ù….")

# --- Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØµØ­ÙŠØ­ ÙˆØ§Ù„Ù…Ø³ØªÙ…Ø± ---
if __name__ == "__main__":
    print("ğŸš€ Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† Ø¨Ù†Ø¬Ø§Ø­...")
    bot.infinity_polling(skip_pending=True)
